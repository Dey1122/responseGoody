<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Respuesta de Pago Niubiz</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin-top: 50px;
      background-color: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      max-width: 600px;
      margin: 0 auto;
    }
    .success {
      color: #28a745;
    }
    .error {
      color: #dc3545;
    }
    .info {
      color: #17a2b8;
    }
    .debug-info {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      padding: 15px;
      margin: 20px 0;
      text-align: left;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Resultado de la Transacci√≥n</h1>
    
    <div id="responseMessage">
      <p class="info">Procesando respuesta de Niubiz...</p>
    </div>

    <div id="debugInfo" class="debug-info">
      <h3>Informaci√≥n de Debug:</h3>
      <p><strong>URL Actual:</strong> <span id="currentUrl"></span></p>
      <p><strong>M√©todo HTTP:</strong> <span id="httpMethod">POST/GET</span></p>
      <div id="allParams"></div>
    </div>
  </div>

  <script>
    console.log('üöÄ P√°gina de respuesta cargada');
    console.log('üìç URL completa:', window.location.href);

    // Funci√≥n para obtener TODOS los par√°metros (URL y POST)
    function getAllParams() {
      const urlParams = new URLSearchParams(window.location.search);
      const hashParams = new URLSearchParams(window.location.hash.substring(1));
      
      const allParams = {};
      
      // Par√°metros de URL (GET)
      for (const [key, value] of urlParams.entries()) {
        allParams[key] = value;
        console.log(`üìù URL Param: ${key} = ${value}`);
      }
      
      // Par√°metros de hash (por si acaso)
      for (const [key, value] of hashParams.entries()) {
        allParams[key] = value;
        console.log(`üîó Hash Param: ${key} = ${value}`);
      }
      
      return allParams;
    }

    // Funci√≥n para detectar datos de formulario POST
    function checkForPostData() {
      // Buscar formularios ocultos que puedan contener datos POST
      const forms = document.querySelectorAll('form');
      const postData = {};
      
      forms.forEach(form => {
        const inputs = form.querySelectorAll('input[type="hidden"]');
        inputs.forEach(input => {
          if (input.name && input.value) {
            postData[input.name] = input.value;
            console.log(`üìã Form Data: ${input.name} = ${input.value}`);
          }
        });
      });
      
      return postData;
    }

    // Funci√≥n para mostrar informaci√≥n de debug
    function showDebugInfo() {
      const url = window.location.href;
      const urlParams = getAllParams();
      const postData = checkForPostData();
      
      document.getElementById('currentUrl').textContent = url;
      
      // Mostrar todos los par√°metros
      let paramsHtml = '<h4>Par√°metros recibidos:</h4>';
      const allData = { ...urlParams, ...postData };
      
      if (Object.keys(allData).length > 0) {
        paramsHtml += '<ul>';
        for (const [key, value] of Object.entries(allData)) {
          paramsHtml += `<li><strong>${key}:</strong> ${value}</li>`;
        }
        paramsHtml += '</ul>';
      } else {
        paramsHtml += '<p>‚ùå No se recibieron par√°metros</p>';
      }
      
      document.getElementById('allParams').innerHTML = paramsHtml;
      
      return allData;
    }

    // Funci√≥n para procesar la respuesta de Niubiz
    function processNiubizResponse(params) {
      const responseMessage = document.getElementById('responseMessage');
      
      // Buscar los par√°metros est√°ndar de Niubiz seg√∫n documentaci√≥n
      const transactionToken = params.transactionToken || params.transactiontoken;
      const customerEmail = params.customerEmail || params.customeremail;
      const channel = params.channel;
      const url = params.url;
      
      console.log('üîç Analizando par√°metros de Niubiz:');
      console.log('- transactionToken:', transactionToken);
      console.log('- customerEmail:', customerEmail);
      console.log('- channel:', channel);
      console.log('- url:', url);
      
      if (transactionToken && transactionToken.trim() !== '') {
        // ‚úÖ Respuesta exitosa de Niubiz
        responseMessage.innerHTML = `
          <h2 class="success">‚úÖ ¬°Pago Completado!</h2>
          <p><strong>Token de Transacci√≥n:</strong> ${transactionToken}</p>
          <p><strong>Email del Cliente:</strong> ${customerEmail || 'No proporcionado'}</p>
          <p><strong>Canal:</strong> ${channel || 'web'}</p>
          ${url ? `<p><strong>URL Adicional:</strong> ${url}</p>` : ''}
          <div class="info">
            <p><strong>‚ö†Ô∏è Importante:</strong> Ahora se procesar√° la autorizaci√≥n autom√°ticamente.</p>
          </div>
        `;
        
        // Enviar datos a Flutter si est√° disponible
        if (window.FlutterNiubiz) {
          const data = {
            type: 'success',
            transactionToken: transactionToken,
            customerEmail: customerEmail,
            channel: channel || 'web'
          };
          console.log('üì± Enviando datos a Flutter:', data);
          window.FlutterNiubiz.postMessage(JSON.stringify(data));
        } else {
          console.log('‚ö†Ô∏è FlutterNiubiz no disponible');
        }
        
      } else if (Object.keys(params).length > 0) {
        // ‚ùå Hay par√°metros pero no el token esperado
        responseMessage.innerHTML = `
          <h2 class="error">‚ùå Respuesta Incompleta</h2>
          <p>Se recibieron datos pero falta el token de transacci√≥n.</p>
          <p>Esto puede indicar que el pago no se complet√≥ correctamente.</p>
        `;
      } else {
        // ‚ÑπÔ∏è No hay par√°metros - acceso directo
        responseMessage.innerHTML = `
          <h2 class="info">‚ÑπÔ∏è P√°gina de Respuesta</h2>
          <p>Esta p√°gina est√° lista para recibir respuestas de Niubiz.</p>
          <p>No se detectaron par√°metros de transacci√≥n en la URL.</p>
        `;
      }
    }

    // Funci√≥n para capturar datos POST cuando lleguen
    function captureIncomingData() {
      // Monitor para cambios en la p√°gina que puedan indicar datos POST
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.type === 'childList') {
            // Re-analizar si hay nuevos datos
            const newParams = showDebugInfo();
            processNiubizResponse(newParams);
          }
        });
      });
      
      observer.observe(document.body, {
        childList: true,
        subtree: true
      });
    }

    // Ejecutar cuando la p√°gina carga
    window.addEventListener('load', function() {
      console.log('üìÑ P√°gina completamente cargada');
      const params = showDebugInfo();
      processNiubizResponse(params);
      captureIncomingData();
    });

    // Tambi√©n ejecutar inmediatamente por si ya tenemos datos
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üèÅ DOM listo');
      const params = showDebugInfo();
      processNiubizResponse(params);
    });

    // Capturar mensajes de otras ventanas/frames
    window.addEventListener('message', function(event) {
      console.log('üì® Mensaje recibido:', event.data);
      if (event.data && typeof event.data === 'object') {
        processNiubizResponse(event.data);
      }
    });

    // Debug: Mostrar info cada 2 segundos por 10 segundos
    let debugCounter = 0;
    const debugInterval = setInterval(() => {
      debugCounter++;
      console.log(`üîÑ Debug check #${debugCounter}`);
      const params = getAllParams();
      if (Object.keys(params).length > 0 || debugCounter >= 5) {
        clearInterval(debugInterval);
        if (Object.keys(params).length > 0) {
          console.log('‚úÖ Par√°metros encontrados, procesando...');
          processNiubizResponse(params);
        }
      }
    }, 2000);
  </script>
</body>
</html>
